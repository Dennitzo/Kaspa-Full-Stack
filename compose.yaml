version: "3.9"

volumes:
  kaspa_db_data:
  k_indexer_db_data:
  portainer_data:

services:
  # ---------------- KASPA NODE ----------------
  kaspad:
    container_name: kaspad
    image: supertypo/rusty-kaspad:latest
    restart: unless-stopped
    ports:
      - "16110:16110"
      - "${KASPA_NODE_PORT}:${KASPA_NODE_PORT}"
    volumes:
      - /var/kaspad:/app/data/
    command: >
      kaspad
      --yes
      --nologfiles
      --disable-upnp
      --utxoindex
      --rpclisten=0.0.0.0:16110
      --rpclisten-borsh=0.0.0.0:${KASPA_NODE_PORT}

  # ---------------- DATABASE (REST / EXPLORER) ----------------
  kaspa_db:
    container_name: kaspa_db
    image: postgres:17-alpine
    restart: unless-stopped
    shm_size: 4G
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    ports:
      - "5432:5432"
    volumes:
      - kaspa_db_data:/var/lib/postgresql/data/

  # ---------------- REST SERVER ----------------
  kaspa_rest_server:
    container_name: kaspa_rest_server
    image: kaspanet/kaspa-rest-server:latest
    restart: unless-stopped
    environment:
      KASPAD_WRPC_URL: ws://kaspad:${KASPA_NODE_PORT}
      SQL_URI: postgresql+asyncpg://${DB_USER}:${DB_PASSWORD}@kaspa_db:5432/${DB_NAME}
      USE_SCRIPT_FOR_ADDRESS: "true"
    ports:
      - "8000:8000"
    depends_on:
      - kaspad
      - kaspa_db

  # ---------------- SOCKET SERVER ----------------
  simply_kaspa_socket_server:
    container_name: simply_kaspa_socket_server
    image: supertypo/simply-kaspa-socket-server:unstable
    restart: unless-stopped
    command: -x 20 -s ws://kaspad:${KASPA_NODE_PORT}
    ports:
      - "8001:8000"
    depends_on:
      - kaspad

  # ---------------- INDEXER (LEGACY) ----------------
  simply_kaspa_indexer:
    container_name: simply_kaspa_indexer
    image: supertypo/simply-kaspa-indexer:latest
    restart: unless-stopped
    command: >
      -u
      -s ws://kaspad:${KASPA_NODE_PORT}
      -d postgresql://${DB_USER}:${DB_PASSWORD}@kaspa_db:5432/${DB_NAME}
      --exclude-fields=tx_out_script_public_key_address
      --prune-db
      --retention=7d
    ports:
      - "8500:8500"
    depends_on:
      - kaspad
      - kaspa_db

  # ---------------- EXPLORER ----------------
  kaspa_explorer:
    container_name: kaspa_explorer
    image: supertypo/kaspa-explorer:latest
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      API_URI: http://yourDomainOrIP:8000
      API_WS_URI: ws://yourDomainOrIP:8001
    depends_on:
      - kaspa_rest_server
      - simply_kaspa_socket_server

  # ---------------- INDEXER 2.0 DATABASE ----------------
  k-indexer-db:
    container_name: k-indexer-db
    image: postgres:17-alpine
    restart: unless-stopped
    shm_size: 4G
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
      PGPORT: ${DB_PORT}
    ports:
      - "${DB_PORT}:${DB_PORT}"
    volumes:
      - k_indexer_db_data:/var/lib/postgresql/data/
    command: >
      -c shared_preload_libraries=pg_stat_statements
      -c pg_stat_statements.max=10000
      -c pg_stat_statements.track=all
      -c pg_stat_statements.save=on

  # ---------------- INDEXER 2.0 ----------------
  simply-kaspa-indexer-2:
    container_name: simply-kaspa-indexer-2
    image: supertypo/simply-kaspa-indexer:latest
    restart: unless-stopped
    command: >
      -s ws://kaspad:${KASPA_NODE_PORT}
      -l 0.0.0.0:8501
      -d postgresql://${DB_USER}:${DB_PASSWORD}@k-indexer-db:${DB_PORT}/${DB_NAME}
      --retention=1h
    ports:
      - "8501:8501"
    depends_on:
      - k-indexer-db

  # ---------------- TRANSACTION PROCESSOR ----------------
  k-transaction-processor:
    container_name: k-transaction-processor
    image: thesheepcat/k-transaction-processor:latest
    restart: unless-stopped
    command: >
      --upgrade-db
      --network ${NETWORK}
      --db-host k-indexer-db
      --db-port ${DB_PORT}
      --db-name ${DB_NAME}
      --db-user ${DB_USER}
      --db-password ${DB_PASSWORD}
      --workers 4
    depends_on:
      - k-indexer-db
      - simply-kaspa-indexer-2

  # ---------------- WEBSERVER ----------------
  k-webserver:
    container_name: k-webserver
    image: thesheepcat/k-webserver:latest
    restart: unless-stopped
    command: >
      --db-host k-indexer-db
      --db-port ${DB_PORT}
      --db-name ${DB_NAME}
      --db-user ${DB_USER}
      --db-password ${DB_PASSWORD}
      --bind-address 0.0.0.0:${WEBSERVER_PORT}
    ports:
      - "${WEBSERVER_PORT}:${WEBSERVER_PORT}"
    depends_on:
      - k-indexer-db
      - simply-kaspa-indexer-2
      - k-transaction-processor

  # ---------------- PORTAINER ----------------
  portainer:
    container_name: portainer
    image: portainer/portainer-ce:latest
    restart: unless-stopped
    ports:
      - "9000:9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
